# VS Code 拡張機能 仕様書

## 1. 概要
本拡張機能は、**C#** のプロジェクトを開いている Visual Studio Code 上で、以下を一括してマークダウン形式で出力するためのものです。

1. Git で管理されているファイル構造（ディレクトリツリー）
2. ソリューションファイル（`.sln`）
3. プロジェクトファイル（`.csproj`）
4. 現在開いているファイルのコード

出力結果は、VS Code の一時的なタブ（保存されていない仮ファイル）に表示され、ユーザはコピー&ペーストして LLM へのプロンプトとして活用する想定です。

---

## 2. ユースケース

1. **コードレビュー・修正依頼などを LLM に依頼したい**  
   - ソリューションファイルやプロジェクトファイルなどを含め、現在作業中のコードをまとめて LLM に渡すことで、依存関係や設定を含めたアドバイスを受けたい。

2. **複数ファイルをまとめて LLM に送信し、変更案を一括で得たい**  
   - 小規模な修正ではなく複数ファイルにまたがる変更のヒントがほしい場合、全ファイルをまとめて提示したい。

---

## 3. 機能要件

1. **Git 管理のファイル構造の取得**  
   - 現在開いているワークスペース(=プロジェクト)内で Git 管理されているファイル・ディレクトリ構造を取得する。  
   - 取得したファイル構造をテキスト出力の冒頭に表示する。  
   - 表示形式はツリー構造や階層を示す簡易的なリストでよい。

2. **ソリューションファイル (`.sln`) の強制出力**  
   - ワークスペース内に `.sln` ファイルが存在する場合は、必ず出力対象とする。  
   - 拡張機能でファイルを取得できなければエラーを出すか、警告表示を行う。  
   - マークダウン出力では、ファイルパスを表示したあとにコードブロックを続ける。

3. **プロジェクトファイル (`.csproj`) の強制出力**  
   - `.csproj` ファイルが存在する場合は、必ず出力対象とする。  
   - 同様に、存在しない場合には警告などを表示し、ユーザに気付きを与える。  
   - 出力形式は `.sln` と同様、ファイルパスのあとにコードブロックを続ける。

4. **現在開いているファイルの取得・出力**  
   - ユーザが VS Code 上で開いているタブのうち、C# ファイル (`.cs`) や関連する設定ファイル (`.json`, `.csproj` など) を選択し、まとめて出力する。  
   - 出力は次の形式で行う:  
     ```
     ファイルパス
     ```言語
     // コード本文
     ```
     ```
   - 複数ファイルが開いている場合、上記フォーマットを連続して記述する。

5. **出力先**  
   - 出力は、VS Code 内で新規に開く一時ファイル (Untitled) として表示する。  
   - ユーザはそこからコピーして LLM に送信することを想定。

---

## 4. 画面・操作フロー

1. **コマンド実行**  
   - コマンドパレット (Ctrl+Shift+P) から拡張機能を呼び出す（例: `Markdown Blocks: Export for LLM`）。

2. **Git 管理ファイル構造の取得**  
   - コマンド実行時、拡張機能はワークスペース・ルートディレクトリから `.git` を辿り、Git 管理対象ファイル一覧を取得する。  
   - ディレクトリツリーとして整形し、テキスト化する。

3. **ソリューションファイル & プロジェクトファイルの検索・読み込み**  
   - `.sln` / `.csproj` のファイルを検索し、読み込む。  
   - 存在しない場合は警告を表示し、続行する（またはユーザに動作を選択させる）。

4. **現在開いているファイルのコード抽出**  
   - VS Code の API を使用し、現在エディタに開いているファイルを取得。  
   - 対象外ファイル（例: バイナリ、画像など）は除外しても良い。  
   - コードを取得する際には、未保存の変更を含める。

5. **出力用テキスト生成**  
   1. **冒頭**  
      - 「Git 管理ファイル構造」のテキストを表示。  
   2. **ソリューションファイル / プロジェクトファイル**  
      - `ソリューションファイルパス`  
        \```xml  
        (ファイル内容)  
        \```  
      - `プロジェクトファイルパス`  
        \```xml  
        (ファイル内容)  
        \```  
   3. **開いているファイルごとに**  
      - `ファイルパス`  
        \```(拡張子に応じた言語)  
        (コード内容)  
        \```  

6. **Untitled ファイルとして開く**  
   - 生成したマークダウンを VS Code の未保存ファイルとして生成・表示する。  
   - ユーザはこれをそのままコピーして LLM へ送信可能。

---

## 5. 実装上のポイント

1. **Git 管理ファイル構造の取得方法**  
   - Node.js の子プロセス経由で `git ls-files` を使用したり、VS Code の提供する Git API を利用できる。  
   - ユーザが複数のリポジトリを開いているケース（複数ルートフォルダ）にも対応可能にするかはオプションとする。

2. **ソリューションファイル & プロジェクトファイルの検索**  
   - ワークスペース直下、またはサブフォルダ内に `.sln` / `.csproj` を再帰的に探す。  
   - 1つのワークスペースに複数 `.sln` / `.csproj` がある場合はどうするか（全て出力 or ひとつに限定）を決める。

3. **コードブロックの言語指定**  
   - `.cs` であれば \```csharp、`.csproj` / `.xml` は \```xml などとする。  
   - 言語指定が難しい場合はデフォルトで \``` だけでも問題ない。

4. **マルチプラットフォーム対応**  
   - Windows / Mac / Linux 上での動作。  
   - パスの区切り文字に注意する。

5. **パフォーマンス**  
   - 取得対象が多すぎる場合は応答が遅くなる可能性があるため、一度に出力できるファイル数の制限や、ファイルサイズの上限を設けるなどの検討が必要。

---

## 6. 例: 出力サンプル

下記はイメージ例です。

```
\`\`\`
# Git File Structure
- .gitignore
- MyProject
  - MyProject.sln
  - MyProject
    - MyProject.csproj
    - Program.cs
    - SomeClass.cs
  - MyProject.Tests
    - MyProject.Tests.csproj
    - ProgramTests.cs

# MyProject.sln
\`\`\`xml
(Solution file content)
\`\`\`

# MyProject/MyProject.csproj
\`\`\`xml
(Project file content)
\`\`\`

# MyProject/Program.cs
\`\`\`csharp
using System;

namespace MyProject
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("Hello World!");
        }
    }
}
\`\`\`

# MyProject/SomeClass.cs
\`\`\`csharp
public class SomeClass
{
    // ...
}
\`\`\`
```